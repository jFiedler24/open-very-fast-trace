<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Requirements Tracing Report</title>
    <style>{{ css|safe }}</style>
</head>
<body>
    <div class="container">
        <header class="report-header">
            <h1>Requirements Tracing Report</h1>
            <div class="status-badge">
                <span class="status-indicator">
                    {%- if trace_result.is_success -%}✓{%- else -%}✗{%- endif -%}
                </span>
                <span class="status-text">
                    {%- if trace_result.is_success -%}
                        All requirements properly traced
                    {%- else -%}
                        Issues found in requirements tracing
                    {%- endif -%}
                </span>
            </div>
        </header>

        <section class="summary">
            <h2>Summary</h2>
            <div class="summary-grid">
                <div class="summary-item">
                    <span class="summary-label">Total Items:</span>
                    <span class="summary-value">{{ trace_result.total_items }}</span>
                </div>
                <div class="summary-item">
                    <span class="summary-label">Defects:</span>
                    <span class="summary-value">{{ trace_result.defect_count }}</span>
                </div>
            </div>
            {%- if trace_result.defect_count > 0 -%}
            <div class="defect-statistics">
                <h3>Defect Breakdown</h3>
                <ul class="defect-stats-list">
                    {%- for message in trace_result.defect_statistics_messages() -%}
                    <li class="defect-stat-item">{{ message }}</li>
                    {%- endfor -%}
                </ul>
            </div>
            {%- endif -%}
        </section>

        {%- if trace_result.defect_count > 0 -%}
        <section class="defects">
            <h2>Defects Found</h2>
            <div class="defect-list">
                {%- for defect in trace_result.defects -%}
                <div class="defect-item" data-defect-item-id="{%- match defect.item_id -%}{%- when Some with (id) -%}{{ id }}{%- when None -%}{%- endmatch -%}">
                    <span class="defect-type">{{ defect.defect_type }}</span>
                    <span class="defect-description">{{ defect.description }}</span>
                    {%- match defect.item_id -%}
                        {%- when Some with (id) -%}
                            <a href="#{{ id.to_html_id() }}" class="defect-item-link" title="Go to {{ id }}">→ View Item</a>
                        {%- when None -%}
                    {%- endmatch -%}
                </div>
                {%- endfor -%}
            </div>
        </section>
        {%- endif -%}

        <section class="specification-items">
            <h2>Specification Items</h2>
            <div class="items-grid">
                {%- for item in trace_result.items -%}
                <div class="spec-item" id="{{ item.item.id.to_html_id() }}" data-req-id="{{ item.item.id }}">
                    <div class="item-header">
                        <h4 class="item-id">{{ item.item.id }}</h4>
                        <div class="item-status">
                            <span class="coverage-badge">{{ item.coverage_status }}</span>
                        </div>
                    </div>
                    
                    <div class="item-content">
                        {%- match item.item.title -%}
                            {%- when Some with (title) -%}
                                <h5 class="item-title">{{ title }}</h5>
                            {%- when None -%}
                        {%- endmatch -%}
                        {%- match item.item.description -%}
                            {%- when Some with (description) -%}
                                <div class="item-description">{{ description }}</div>
                            {%- when None -%}
                        {%- endmatch -%}
                    </div>

                    <div class="item-metadata">
                        {%- match item.item.location -%}
                            {%- when Some with (location) -%}
                                <div class="metadata-row">
                                    <span class="metadata-label">Location:</span>
                                    <span class="metadata-value">{{ location }}</span>
                                </div>
                            {%- when None -%}
                        {%- endmatch -%}
                        {%- if !item.item.needs.is_empty() -%}
                        <div class="metadata-row">
                            <span class="metadata-label">Needs:</span>
                            <span class="metadata-value">{{ item.item.needs|join(", ") }}</span>
                        </div>
                        {%- endif -%}
                        {%- if !item.item.covers.is_empty() -%}
                        <div class="metadata-row">
                            <span class="metadata-label">Covers:</span>
                            <span class="metadata-value">
                                {%- for cover_id in item.item.covers -%}
                                    <span class="requirement-link">{{ cover_id }}</span>
                                    {%- if !loop.last -%}, {%- endif -%}
                                {%- endfor -%}
                            </span>
                        </div>
                        {%- endif -%}
                        {%- if !item.item.depends.is_empty() -%}
                        <div class="metadata-row">
                            <span class="metadata-label">Depends:</span>
                            <span class="metadata-value">
                                {%- for depend_id in item.item.depends -%}
                                    <span class="requirement-link">{{ depend_id }}</span>
                                    {%- if !loop.last -%}, {%- endif -%}
                                {%- endfor -%}
                            </span>
                        </div>
                        {%- endif -%}
                        {%- if !item.outgoing_links.is_empty() -%}
                        <div class="metadata-row">
                            <span class="metadata-label">Outgoing Links:</span>
                            <span class="metadata-value">
                                {%- for link in item.outgoing_links -%}
                                    <span class="requirement-link link-{{ link.status }}">{{ link.target_id }}</span>
                                    {%- if !loop.last -%}, {%- endif -%}
                                {%- endfor -%}
                            </span>
                        </div>
                        {%- endif -%}
                        {%- if !item.incoming_links.is_empty() -%}
                        <div class="metadata-row">
                            <span class="metadata-label">Incoming Links:</span>
                            <span class="metadata-value">
                                {%- for link in item.incoming_links -%}
                                    {%- match link.source_id -%}
                                        {%- when Some with (source_id) -%}
                                            <span class="requirement-link link-{{ link.status }}">{{ source_id }}</span>
                                        {%- when None -%}
                                            <span class="requirement-link link-{{ link.status }}">Unknown</span>
                                    {%- endmatch -%}
                                    {%- if !loop.last -%}, {%- endif -%}
                                {%- endfor -%}
                            </span>
                        </div>
                        {%- endif -%}
                    </div>
                </div>
                {%- endfor -%}
            </div>
        </section>
    </div>
    
    <script>
        // [impl->req~html-compliant-anchors~1]
        // [impl->req~defect-requirement-linking~1]
        // Make requirement IDs clickable by adding hyperlinks
        document.addEventListener('DOMContentLoaded', function() {
            // Create a map of requirement ID to HTML-safe anchor ID
            const requirementElements = document.querySelectorAll('.spec-item');
            const idToAnchor = new Map();
            
            requirementElements.forEach((element) => {
                const reqId = element.getAttribute('data-req-id');
                if (reqId) {
                    // HTML-safe ID is already set on the element
                    const anchorId = element.id;
                    idToAnchor.set(reqId, anchorId);
                }
            });
            
            // Convert requirement text to links in metadata sections
            const requirementLinks = document.querySelectorAll('.requirement-link');
            requirementLinks.forEach(linkElement => {
                const reqId = linkElement.textContent.trim();
                if (idToAnchor.has(reqId)) {
                    // Convert span to anchor
                    const anchor = document.createElement('a');
                    anchor.href = '#' + idToAnchor.get(reqId);
                    anchor.className = linkElement.className;
                    anchor.textContent = linkElement.textContent;
                    linkElement.parentNode.replaceChild(anchor, linkElement);
                }
            });
            
            // Convert requirement IDs in defect descriptions to clickable links
            const defectDescriptions = document.querySelectorAll('.defect-description');
            defectDescriptions.forEach(descElement => {
                let html = descElement.innerHTML;
                // Match requirement ID patterns like "req~name~1" or "dsn~name~2"
                const reqIdPattern = /\b([a-z]+)~([a-zA-Z0-9-_]+)~(\d+)\b/g;
                html = html.replace(reqIdPattern, (match) => {
                    if (idToAnchor.has(match)) {
                        return `<a href="#${idToAnchor.get(match)}" class="defect-req-link">${match}</a>`;
                    }
                    return match;
                });
                descElement.innerHTML = html;
            });
            
            // Add smooth scrolling
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'center'
                        });
                        // Highlight the target briefly
                        target.style.backgroundColor = '#fff3cd';
                        setTimeout(() => {
                            target.style.backgroundColor = '';
                        }, 2000);
                    }
                });
            });
        });
    </script>
</body>
</html>